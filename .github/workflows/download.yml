name: Generate macOS Ventura Recovery Image

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Ventura Full Installer (13.7.6)
        run: |
          softwareupdate --list-full-installers
          sudo softwareupdate --fetch-full-installer --full-installer-version 13.7.6

      - name: Create Ventura Installer Disk Image
        run: |
          sudo hdiutil create -o /tmp/Ventura -size 16000m -layout GPTSPUD -fs HFS+J -volname "Ventura"
          sudo hdiutil attach /tmp/Ventura.dmg -noverify -mountpoint /Volumes/Ventura
          sleep 10
          sudo /Applications/Install\ macOS\ Ventura.app/Contents/Resources/createinstallmedia \
            --volume /Volumes/Ventura --nointeraction

      - name: Copy com.apple.recovery.boot
        run: |
          cp -R "/Volumes/Install macOS Ventura/com.apple.recovery.boot" /tmp/recovery-ventura

      - name: Upload com.apple.recovery.boot
        uses: actions/upload-artifact@v4
        with:
          name: com.apple.recovery.boot
          path: /tmp/recovery-ventura/*
          compression-level: 9
